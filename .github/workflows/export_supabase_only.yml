name: Export Supabase Only

on:
  workflow_dispatch:

jobs:
  export_supabase:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3 xz-utils

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restore sqlite from dump
        run: |
          set -euxo pipefail
          ls -lah data || true
          test -f data/jxd_dump.sql.xz
          rm -f data/jxd.sqlite

          xz -dc data/jxd_dump.sql.xz \
            | python3 scripts/strip_unistr.py \
            | sqlite3 data/jxd.sqlite

          sqlite3 data/jxd.sqlite ".tables"
          sqlite3 data/jxd.sqlite "select count(*) as seasons_count from seasons;"
          sqlite3 data/jxd.sqlite "select count(*) as teams_count from teams;"
          sqlite3 data/jxd.sqlite "select count(*) as teams_named from teams where name is not null and trim(name) != '';"
          sqlite3 data/jxd.sqlite "select id,name,short_code from teams where name is not null limit 5;"

      - name: SQLite sanity (league 8 + Arsenal)
        run: |
          set -euxo pipefail

          echo "== league 8 seasons =="
          sqlite3 data/jxd.sqlite "
            select id,name,start_date,end_date,is_current
            from seasons
            where league_id=8
            order by end_date desc
            limit 5;
          "

          echo "== Arsenal in SQLite teams =="
          sqlite3 data/jxd.sqlite "
            select id,name,short_code from teams where id=19;
          "

          echo "== Arsenal fixtures since 2025-08-01 (SQLite, ANY) =="
          sqlite3 data/jxd.sqlite "
            select count(*)
            from fixtures
            where (home_team_id=19 or away_team_id=19)
              and starting_at >= '2025-08-01';
          "

          echo "== Arsenal fixtures since 2025-08-01 (SQLite, SCORED) =="
          sqlite3 data/jxd.sqlite "
            select count(*)
            from fixtures
            where (home_team_id=19 or away_team_id=19)
              and starting_at >= '2025-08-01'
              and home_score is not null
              and away_score is not null;
          "

          echo "== Latest Arsenal fixture in SQLite (ANY) =="
          sqlite3 data/jxd.sqlite "
            select max(starting_at)
            from fixtures
            where (home_team_id=19 or away_team_id=19);
          "

          echo "== Latest Arsenal fixture in SQLite (SCORED) =="
          sqlite3 data/jxd.sqlite "
            select max(starting_at)
            from fixtures
            where (home_team_id=19 or away_team_id=19)
              and home_score is not null
              and away_score is not null;
          "

      - name: Export to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -euxo pipefail
          python3 scripts/export_to_supabase.py --strict

      - name: Verify Supabase counts (REST)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -euxo pipefail

          for t in seasons teams fixtures; do
            echo "== $t =="
            curl -s -D - -o /dev/null \
              -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
              -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
              -H "Prefer: count=exact" \
              "$SUPABASE_URL/rest/v1/$t?select=id&limit=1" | grep -i content-range || true
          done

          echo "== sample teams =="
          curl -s \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            "$SUPABASE_URL/rest/v1/teams?select=id,name,short_code&limit=10"

          echo "== arsenal latest scored fixture =="
          export FIXTURE_JSON="$(curl -s \
            -H \"apikey: $SUPABASE_SERVICE_ROLE_KEY\" \
            -H \"Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY\" \
            \"$SUPABASE_URL/rest/v1/fixtures?select=starting_at&or=(home_team_id.eq.19,away_team_id.eq.19)&home_score=not.is.null&away_score=not.is.null&order=starting_at.desc&limit=1\")"
          echo \"${FIXTURE_JSON}\"

          python3 - <<'PY'
          import datetime
          import json
          import os
          import sys

          raw = os.environ.get("FIXTURE_JSON", "")
          try:
              data = json.loads(raw or "[]")
          except Exception as exc:  # pragma: no cover - CI guard
              print(f"Failed to parse Arsenal fixture JSON: {exc}")
              sys.exit(1)

          if not data:
              print("No Arsenal fixtures with scores found; failing.")
              sys.exit(1)

          start = data[0].get("starting_at")
          print(f"latest starting_at: {start}")
          if not start:
              print("Missing starting_at; failing.")
              sys.exit(1)

          try:
              dt = datetime.datetime.fromisoformat(start.replace("Z", "+00:00")).replace(tzinfo=None)
          except Exception as exc:  # pragma: no cover - CI guard
              print(f"Could not parse date: {exc}")
              sys.exit(1)

          threshold = datetime.datetime(2025, 8, 1)
          if dt < threshold:
              print("Latest Arsenal scored fixture before 2025-08-01; failing.")
              sys.exit(1)

          print("Arsenal scored fixture ok.")
          PY
