name: Export Supabase Only

on:
  workflow_dispatch:

jobs:
  export_supabase:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3 xz-utils

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restore sqlite from dump
        run: |
          set -euxo pipefail
          ls -lah data || true
          test -f data/jxd_dump.sql.xz
          rm -f data/jxd.sqlite

          xz -dc data/jxd_dump.sql.xz \
            | python3 scripts/strip_unistr.py \
            | sqlite3 data/jxd.sqlite

          sqlite3 data/jxd.sqlite ".tables"
          sqlite3 data/jxd.sqlite "select count(*) as seasons_count from seasons;"
          sqlite3 data/jxd.sqlite "select count(*) as teams_count from teams;"
          sqlite3 data/jxd.sqlite "select count(*) as teams_named from teams where name is not null and trim(name) != '';"
          sqlite3 data/jxd.sqlite "select id,name,short_code from teams where name is not null limit 5;"

      - name: Export to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -euxo pipefail
          python3 scripts/export_to_supabase.py --strict

      - name: Verify Supabase counts (REST)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -euxo pipefail

          for t in seasons teams fixtures; do
            echo "== $t =="
            curl -s -D - -o /dev/null \
              -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
              -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
              -H "Prefer: count=exact" \
              "$SUPABASE_URL/rest/v1/$t?select=id&limit=1" | grep -i content-range || true
          done

          echo "== sample teams =="
          curl -s \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            "$SUPABASE_URL/rest/v1/teams?select=id,name,short_code&limit=10"
