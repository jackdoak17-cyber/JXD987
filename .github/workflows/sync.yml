name: Sync SportMonks Data

on:
  schedule:
    # Hourly odds (Bet365)
    - cron: "0 * * * *"
    # Twice daily stats window (next 7 days)
    - cron: "0 0,12 * * *"
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  LEAGUE_IDS: "8,9,72,82,181,208,244,271,301,384,387,444,453,462,501,564,567,573,591,600"
  BOOKMAKER_ID: "2"
  REQUESTS_PER_HOUR: "3500"

jobs:
  odds_hourly:
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 * * * *'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install deps
        run: python -m pip install --upgrade pip && python -m pip install -r requirements.txt
      - name: Sync odds (Bet365 scoped)
        env:
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
          LEAGUE_IDS: ${{ env.LEAGUE_IDS }}
        run: |
          python -m jxd.cli sync-odds --bookmaker-id $BOOKMAKER_ID --league-ids "$LEAGUE_IDS" --limit 200
      - name: Upload DB artifact (odds run)
        uses: actions/upload-artifact@v4
        with:
          name: jxd-sqlite-odds
          path: data/jxd.sqlite

  stats_twice_daily:
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 0,12 * * *'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install deps
        run: python -m pip install --upgrade pip && python -m pip install -r requirements.txt
      - name: Sync static (idempotent)
        env:
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
        run: |
          python -m jxd.cli sync-static
      - name: Sync upcoming 7 days with details (capped)
        env:
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
          LEAGUE_IDS: ${{ env.LEAGUE_IDS }}
        run: |
          start=$(date +%F)
          end=$(date -d "+7 days" +%F)
          python -m jxd.cli sync-fixtures-between "$start" "$end" --with-details --league-ids "$LEAGUE_IDS" --limit 400
      - name: Upload DB artifact (stats run)
        uses: actions/upload-artifact@v4
        with:
          name: jxd-sqlite-stats
          path: data/jxd.sqlite
