name: Sync SportMonks Data

on:
  schedule:
    # Hourly odds (Bet365)
    - cron: "0 * * * *"
    # Twice daily stats window (next 7 days)
    - cron: "0 0,12 * * *"
    # Daily deep history window to keep 50+ game form
    - cron: "0 3 * * *"
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  LEAGUE_IDS: "8,9,72,82,181,208,244,271,301,384,387,444,453,462,501,564,567,573,591,600"
  BOOKMAKER_ID: "2"
  REQUESTS_PER_HOUR: "3500"

jobs:
  odds_hourly:
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 * * * *'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install deps
        run: python -m pip install --upgrade pip && python -m pip install -r requirements.txt
      - name: Sync odds (Bet365 scoped)
        env:
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
          LEAGUE_IDS: ${{ env.LEAGUE_IDS }}
        run: |
          python -m jxd.cli sync-odds --bookmaker-id $BOOKMAKER_ID --league-ids "$LEAGUE_IDS" --limit 200
      - name: Sync player odds (Bet365 player props)
        env:
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
          LEAGUE_IDS: ${{ env.LEAGUE_IDS }}
        run: |
          python -m jxd.cli sync-player-odds --bookmaker-id $BOOKMAKER_ID --league-ids "$LEAGUE_IDS" --days-forward 7 --limit 200
      - name: Normalize odds snapshot
        env:
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
        run: |
          python -m jxd.cli normalize-odds
      - name: Upload DB artifact (odds run)
        uses: actions/upload-artifact@v4
        with:
          name: jxd-sqlite-odds
          path: data/jxd.sqlite

  inplay_quarter_hourly:
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '*/15 * * * *'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install deps
        run: python -m pip install --upgrade pip && python -m pip install -r requirements.txt
      - name: Sync livescores (lightweight)
        env:
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
        run: |
          python -m jxd.cli sync-livescores --limit 400
      - name: Sync inplay odds (Bet365 scoped, latest snapshot)
        env:
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
        run: |
          python -m jxd.cli sync-inplay-odds --bookmaker-id $BOOKMAKER_ID --limit 400
      - name: Normalize odds snapshot
        env:
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
        run: |
          python -m jxd.cli normalize-odds
      - name: Upload DB artifact (inplay run)
        uses: actions/upload-artifact@v4
        with:
          name: jxd-sqlite-inplay
          path: data/jxd.sqlite

  stats_twice_daily:
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 0,12 * * *'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install deps
        run: python -m pip install --upgrade pip && python -m pip install -r requirements.txt
      - name: Sync static (idempotent)
        env:
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
        run: |
          python -m jxd.cli sync-static
      - name: Sync teams for configured leagues
        env:
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
          LEAGUE_IDS: ${{ env.LEAGUE_IDS }}
        run: |
          python -m jxd.cli sync-league-teams --league-ids "$LEAGUE_IDS"
      - name: Sync upcoming 7 days with details (capped)
        env:
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
          LEAGUE_IDS: ${{ env.LEAGUE_IDS }}
        run: |
          start=$(date +%F)
          end=$(date -d "+7 days" +%F)
          python -m jxd.cli sync-fixtures-between "$start" "$end" --with-details --league-ids "$LEAGUE_IDS" --limit 400
      - name: Recompute forms and availability
        env:
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
        run: |
          python -m jxd.cli compute-forms --samples "5,10,15,20,25,50" --availability-sample 2
      - name: Normalize odds snapshot (post-stats)
        env:
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
        run: |
          python -m jxd.cli normalize-odds
      - name: Upload DB artifact (stats run)
        uses: actions/upload-artifact@v4
        with:
          name: jxd-sqlite-stats
          path: data/jxd.sqlite

  history_daily:
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 3 * * *'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install deps
        run: python -m pip install --upgrade pip && python -m pip install -r requirements.txt
      - name: Full refresh (deep history + odds + forms + dump)
        env:
          SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
          LEAGUE_IDS: ${{ env.LEAGUE_IDS }}
          DAYS_BACK: 450
          DAYS_FORWARD: 14
          HISTORY_LIMIT: 4000
          ODDS_LIMIT: 1200
          BOOKMAKER_ID: ${{ env.BOOKMAKER_ID }}
        run: |
          chmod +x scripts/full_refresh.sh
          ./scripts/full_refresh.sh

      - name: Post-sync SQLite scored checks
        run: |
          set -euxo pipefail
          echo "== max scored fixture start =="
          sqlite3 data/jxd.sqlite "select max(starting_at) from fixtures where home_score is not null and away_score is not null;"
          echo "== league 8 scored since 2025-08-01 =="
          sqlite3 data/jxd.sqlite "
            select count(*) from fixtures
            where league_id=8
              and starting_at >= '2025-08-01'
              and home_score is not null
              and away_score is not null;
          "
      - name: Export Supabase (keep current + previous season per league)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          python3 scripts/export_to_supabase.py

      - name: Supabase scored sanity (league 8 since 2025-08-01)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -euxo pipefail
          curl -s -D - -o /dev/null \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Prefer: count=exact" \
            "$SUPABASE_URL/rest/v1/fixtures?league_id=eq.8&starting_at=gte.2025-08-01&home_score=not.is.null&away_score=not.is.null&select=id&limit=1" \
            | grep -i content-range || true
      - name: Upload DB artifact (sqlite + dump)
        uses: actions/upload-artifact@v4
        with:
          name: jxd-history
          path: |
            data/jxd.sqlite
            data/jxd_dump.sql.xz
